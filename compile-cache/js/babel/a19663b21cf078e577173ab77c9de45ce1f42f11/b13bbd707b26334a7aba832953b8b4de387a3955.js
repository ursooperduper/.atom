Object.defineProperty(exports, '__esModule', {
	value: true
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/* globals atom */

var _eventKit = require('event-kit');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _reactDomPragma = require('react-dom-pragma');

var _reactDomPragma2 = _interopRequireDefault(_reactDomPragma);

var _lazyReq = require('lazy-req');

var _lazyReq2 = _interopRequireDefault(_lazyReq);

'use babel';

var lazyReq = (0, _lazyReq2['default'])(require);
var lodash = lazyReq('lodash');
var jshint = lazyReq('jshint');
var jsxhint = lazyReq('jshint-jsx');
var cli = lazyReq('jshint/src/cli');
var loadConfig = lazyReq('./load-config');
var plugin = {};
var markersByEditorId = {};
var errorsByEditorId = {};
var subscriptionTooltips = new _eventKit.CompositeDisposable();
var _ = undefined;

var SUPPORTED_GRAMMARS = ['source.js', 'source.jsx', 'source.js.jsx'];

var jsHintStatusBar = document.createElement('span');
jsHintStatusBar.setAttribute('id', 'jshint-statusbar');
jsHintStatusBar.classList.add('inline-block');

var updateStatusText = function updateStatusText(line, character, reason) {
	jsHintStatusBar.textContent = line && character && reason ? 'JSHint ' + line + ':' + character + ' ' + reason : '';
};

var getMarkersForEditor = function getMarkersForEditor() {
	var editor = atom.workspace.getActiveTextEditor();

	if (editor && markersByEditorId[editor.id]) {
		return markersByEditorId[editor.id];
	}

	return {};
};

var getErrorsForEditor = function getErrorsForEditor() {
	var editor = atom.workspace.getActiveTextEditor();

	if (editor && errorsByEditorId[editor.id]) {
		return errorsByEditorId[editor.id];
	}

	return [];
};

var destroyMarkerAtRow = function destroyMarkerAtRow(row) {
	var editor = atom.workspace.getActiveTextEditor();
	if (markersByEditorId[editor.id] && markersByEditorId[editor.id][row]) {
		markersByEditorId[editor.id][row].destroy();
		delete markersByEditorId[editor.id][row];
	}
};

var getRowForError = function getRowForError(error) {
	var line = error[0].line || 1; // JSHint reports `line: 0` when config error
	var row = line - 1;
	return row;
};

var clearOldMarkers = function clearOldMarkers(errors) {
	subscriptionTooltips.dispose();

	var rows = _.map(errors, function (error) {
		return getRowForError(error);
	});

	var oldMarkers = getMarkersForEditor();
	_.each(_.keys(oldMarkers), function (row) {
		if (!_.contains(rows, row)) {
			destroyMarkerAtRow(row);
		}
	});
};

var saveMarker = function saveMarker(marker, row) {
	var editor = atom.workspace.getActiveTextEditor();

	if (!markersByEditorId[editor.id]) {
		markersByEditorId[editor.id] = {};
	}

	markersByEditorId[editor.id][row] = marker;
};

var getMarkerAtRow = function getMarkerAtRow(row) {
	var editor = atom.workspace.getActiveTextEditor();

	if (!markersByEditorId[editor.id]) {
		return null;
	}

	return markersByEditorId[editor.id][row];
};

var updateStatusbar = function updateStatusbar() {
	var statusBar = atom.views.getView(atom.workspace).querySelector('.status-bar');
	if (!statusBar) {
		return;
	}

	if (!jsHintStatusBar.parentNode) {
		statusBar.addLeftTile({ item: jsHintStatusBar });
	}

	var editor = atom.workspace.getActiveTextEditor();
	if (!editor || !errorsByEditorId[editor.id]) {
		updateStatusText();
		return;
	}

	var line = editor.getCursorBufferPosition().row + 1;
	var error = errorsByEditorId[editor.id][line] || _.first(_.compact(errorsByEditorId[editor.id]));
	error = error[0];

	updateStatusText(error.line, error.character, error.reason);
};

var getReasonsForError = function getReasonsForError(error) {
	return _.map(error, function (el) {
		return el.character + ': ' + el.reason;
	});
};

var addReasons = function addReasons(marker, error) {
	var row = getRowForError(error);
	var editorElement = atom.views.getView(atom.workspace.getActiveTextEditor());
	var reasons = '<div class="jshint-errors">' + getReasonsForError(error).join('<br>') + '</div>';

	var target = editorElement.shadowRoot.querySelectorAll('.jshint-line-number.line-number-' + row);
	var tooltip = atom.tooltips.add(target, {
		title: reasons,
		placement: 'bottom',
		delay: { show: 200 }
	});
	subscriptionTooltips.add(tooltip);
};

var displayError = function displayError(error) {
	var row = getRowForError(error);

	if (getMarkerAtRow(row)) {
		return;
	}

	var editor = atom.workspace.getActiveTextEditor();
	var marker = editor.markBufferRange([[row, 0], [row, 1]]);
	editor.decorateMarker(marker, { type: 'line', 'class': 'jshint-line' });
	editor.decorateMarker(marker, { type: 'line-number', 'class': 'jshint-line-number' });
	saveMarker(marker, row);
	addReasons(marker, error);
};

var displayErrors = function displayErrors() {
	var errors = _.compact(getErrorsForEditor());
	clearOldMarkers(errors);
	updateStatusbar();
	_.each(errors, displayError);
};

var removeMarkersForEditorId = function removeMarkersForEditorId(id) {
	if (markersByEditorId[id]) {
		delete markersByEditorId[id];
	}
};

var removeErrorsForEditorId = function removeErrorsForEditorId(id) {
	if (errorsByEditorId[id]) {
		delete errorsByEditorId[id];
	}
};

var lint = function lint() {
	var editor = atom.workspace.getActiveTextEditor();

	if (!editor) {
		return;
	}

	if (SUPPORTED_GRAMMARS.indexOf(editor.getGrammar().scopeName) === -1) {
		return;
	}

	var file = editor.getURI();

	// Hack to make JSHint look for .jshintignore in the correct dir
	// Because JSHint doesn't use its `cwd` option
	process.chdir(_path2['default'].dirname(file));

	// Remove errors and don't lint if file is ignored in .jshintignore
	if (file && cli().gather({ args: [file] }).length === 0) {
		removeErrorsForEditorId(editor.id);
		displayErrors();
		removeMarkersForEditorId(editor.id);
		return;
	}

	var config = file ? loadConfig()(file) : {};

	var linter = atom.config.get('jshint.supportLintingJsx') || atom.config.get('jshint.transformJsx') ? jsxhint().JSXHINT : jshint().JSHINT;

	var origCode = editor.getText();
	var grammarScope = editor.getGrammar().scopeName;
	var isJsx = grammarScope === 'source.jsx' || grammarScope === 'source.js.jsx';
	var code = isJsx ? (0, _reactDomPragma2['default'])(origCode) : origCode;
	var pragmaWasAdded = code !== origCode;

	try {
		linter(code, config, config.globals);
	} catch (err) {}

	removeErrorsForEditorId(editor.id);

	// workaround the errors array sometimes containing `null`
	var errors = _.compact(linter.errors);

	if (errors.length > 0) {
		(function () {
			// aggregate same-line errors
			var ret = [];
			_.each(errors, function (el) {
				if (pragmaWasAdded) {
					el.line--;
				}

				var l = el.line;

				if (Array.isArray(ret[l])) {
					ret[l].push(el);

					ret[l] = _.sortBy(ret[l], function (el) {
						return el.character;
					});
				} else {
					ret[l] = [el];
				}
			});

			errorsByEditorId[editor.id] = ret;
		})();
	}

	displayErrors();
};

var debouncedLint = null;
var debouncedDisplayErrors = null;
var debouncedUpdateStatusbar = null;

var registerEvents = function registerEvents() {
	lint();
	var workspaceElement = atom.views.getView(atom.workspace);

	debouncedLint = debouncedLint || _.debounce(lint, 50);
	debouncedDisplayErrors = debouncedDisplayErrors || _.debounce(displayErrors, 200);
	debouncedUpdateStatusbar = debouncedUpdateStatusbar || _.debounce(updateStatusbar, 100);

	atom.workspace.observeTextEditors(function (editor) {
		var buffer = editor.getBuffer();

		editor.emitter.off('scroll-top-changed', debouncedDisplayErrors);
		editor.emitter.off('did-change-cursor-position', debouncedUpdateStatusbar);
		buffer.emitter.off('did-save did-change-modified', debouncedLint);

		if (!atom.config.get('jshint.validateOnlyOnSave')) {
			buffer.onDidChangeModified(debouncedLint);
		}

		buffer.onDidSave(debouncedLint);

		editor.onDidChangeScrollTop(debouncedDisplayErrors);
		editor.onDidChangeCursorPosition(debouncedUpdateStatusbar);
	});

	workspaceElement.addEventListener('editor:will-be-removed', function (e, editorView) {
		if (editorView && editorView.editor) {
			removeErrorsForEditorId(editorView.editor.id);
			removeMarkersForEditorId(editorView.editor.id);
		}
	});
};

var config = plugin.config = {
	validateOnlyOnSave: {
		type: 'boolean',
		'default': false
	},
	supportLintingJsx: {
		type: 'boolean',
		'default': false,
		title: 'Support Linting JSX'
	}
};

exports.config = config;
var activate = plugin.activate = function () {
	_ = lodash();
	registerEvents();
	atom.config.observe('jshint.validateOnlyOnSave', registerEvents);
	atom.commands.add('atom-workspace', 'jshint:lint', lint);
};

exports.activate = activate;
exports['default'] = plugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zYXJhaC8uYXRvbS9wYWNrYWdlcy9qc2hpbnQvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7d0JBR29DLFdBQVc7O29CQUM5QixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7Ozt1QkFDckIsVUFBVTs7OztBQU5sQyxXQUFXLENBQUM7O0FBUVosSUFBTSxPQUFPLEdBQUcsMEJBQVksT0FBTyxDQUFDLENBQUM7QUFDckMsSUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2pDLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNqQyxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdEMsSUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDdEMsSUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQzVDLElBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztBQUNsQixJQUFNLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztBQUM3QixJQUFNLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztBQUM1QixJQUFNLG9CQUFvQixHQUFHLGNBZHBCLG1CQUFtQixFQWMwQixDQUFDO0FBQ3ZELElBQUksQ0FBQyxZQUFBLENBQUM7O0FBRU4sSUFBTSxrQkFBa0IsR0FBRyxDQUMxQixXQUFXLEVBQ1gsWUFBWSxFQUNaLGVBQWUsQ0FDZixDQUFDOztBQUVGLElBQU0sZUFBZSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDdkQsZUFBZSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztBQUN2RCxlQUFlLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQzs7QUFFOUMsSUFBTSxnQkFBZ0IsR0FBRyxTQUFuQixnQkFBZ0IsQ0FBSSxJQUFJLEVBQUUsU0FB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Q2xCLE1BQUksRUFBRSxTQUFTO0FBQ2YsYUFBUyxLQUFLO0FBQ2QsT0FBSyxFQUFFLHFCQUFxQjtFQUM1QjtDQUNELENBQUM7O1FBVlcsTUFBTSxHQUFOLE1BQU07QUFZWixJQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxHQUFHLFlBQU07QUFDL0MsRUFBQyxHQUFHLE1BQU0sRUFBRSxDQUFDO0FBQ2IsZUFBYyxFQUFFLENBQUM7QUFDakIsS0FBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsMkJBQTJCLEVBQUUsY0FBYyxDQUFDLENBQUM7QUFDakUsS0FBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO0NBQ3pELENBQUM7O1FBTFcsUUFBUSxHQUFSLFFBQVE7cUJBT04sTUFBTSIsImZpbGUiOiIvVXNlcnMvc2FyYWgvLmF0b20vcGFja2FnZXMvanNoaW50L2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG5cbi8qIGdsb2JhbHMgYXRvbSAqL1xuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSB9IGZyb20gJ2V2ZW50LWtpdCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCByZWFjdERvbVByYWdtYSBmcm9tICdyZWFjdC1kb20tcHJhZ21hJztcbmltcG9ydCBsYXp5UmVxdWlyZSBmcm9tICdsYXp5LXJlcSc7XG5cbmNvbnN0IGxhenlSZXEgPSBsYXp5UmVxdWlyZShyZXF1aXJlKTtcbmNvbnN0IGxvZGFzaCA9IGxhenlSZXEoJ2xvZGFzaCcpO1xuY29uc3QganNoaW50ID0gbGF6eVJlcSgnanNoaW50Jyk7XG5jb25zdCBqc3hoaW50ID0gbGF6eVJlcSgnanNoaW50LWpzeCcpO1xuY29uc3QgY2xpID0gbGF6eVJlcSgnanNoaW50L3NyYy9jbGknKTtcbmNvbnN0IGxvYWRDb25maWcgPSBsYXp5UmVxKCcuL2xvYWQtY29uZmlnJyk7XG5jb25zdCBwbHVnaW4gPSB7fTtcbmNvbnN0IG1hcmtlcnNCeUVkaXRvcklkID0ge307XG5jb25zdCBlcnJvcnNCeUVkaXRvcklkID0ge307XG5jb25zdCBzdWJzY3JpcHRpb25Ub29sdGlwcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG5sZXQgXztcblxuY29uc3QgU1VQUE9SVEVEX0dSQU1NQVJTID0gW1xuXHQnc291cmNlLmpzJyxcblx0J3NvdXJjZS5qc3gnLFxuXHQnc291cmNlLmpzLmpzeCdcbl07XG5cbmNvbnN0IGpzSGludFN0YXR1c0JhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcbmpzSGludFN0YXR1c0Jhci5zZXRBdHRyaWJ1dGUoJ2lkJywgJ2pzaGludC1zdGF0dXNiYXInKTtcbmpzSGludFN0YXR1c0Jhci5jbGFzc0xpc3QuYWRkKCdpbmxpbmUtYmxvY2snKTtcblxuY29uc3QgdXBkYXRlU3RhdHVzVGV4dCA9IChsaW5lLCBjaGFyYWN0ZXIsIHJlYXNvbikgPT4ge1xuXHRqc0hpbnRTdGF0dXNCYXIudGV4dENvbnRlbnQgPSBsaW5lICYmIGNoYXJhY3RlciAmJiByZWFzb24gPyBgSlNIaW50ICR7bGluZX06JHtjaGFyYWN0ZXJ9ICR7cmVhc29ufWAgOiAnJztcbn07XG5cbmNvbnN0IGdldE1hcmtlcnNGb3JFZGl0b3IgPSAoKSA9PiB7XG5cdGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblxuXHRpZiAoZWRpdG9yICYmIG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF0pIHtcblx0XHRyZXR1cm4gbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXTtcblx0fVxuXG5cdHJldHVybiB7fTtcbn07XG5cbmNvbnN0IGdldEVycm9yc0ZvckVkaXRvciA9ICgpID0+IHtcblx0Y29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG5cdGlmIChlZGl0b3IgJiYgZXJyb3JzQnlFZGl0b3JJZFtlZGl0b3IuaWRdKSB7XG5cdFx0cmV0dXJuIGVycm9yc0J5RWRpdG9ySWRbZWRpdG9yLmlkXTtcblx0fVxuXG5cdHJldHVybiBbXTtcbn07XG5cbmNvbnN0IGRlc3Ryb3lNYXJrZXJBdFJvdyA9IHJvdyA9PiB7XG5cdGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblx0aWYgKG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF0gJiYgbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXVtyb3ddKSB7XG5cdFx0bWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXVtyb3ddLmRlc3Ryb3koKTtcblx0XHRkZWxldGUgbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXVtyb3ddO1xuXHR9XG59O1xuXG5jb25zdCBnZXRSb3dGb3JFcnJvciA9IGVycm9yID0+IHtcblx0Y29uc3QgbGluZSA9IGVycm9yWzBdLmxpbmUgfHwgMTsgLy8gSlNIaW50IHJlcG9ydHMgYGxpbmU6IDBgIHdoZW4gY29uZmlnIGVycm9yXG5cdGNvbnN0IHJvdyA9IGxpbmUgLSAxO1xuXHRyZXR1cm4gcm93O1xufTtcblxuY29uc3QgY2xlYXJPbGRNYXJrZXJzID0gZXJyb3JzID0+IHtcblx0c3Vic2NyaXB0aW9uVG9vbHRpcHMuZGlzcG9zZSgpO1xuXG5cdGNvbnN0IHJvd3MgPSBfLm1hcChlcnJvcnMsIGVycm9yID0+IGdldFJvd0ZvckVycm9yKGVycm9yKSk7XG5cblx0Y29uc3Qgb2xkTWFya2VycyA9IGdldE1hcmtlcnNGb3JFZGl0b3IoKTtcblx0Xy5lYWNoKF8ua2V5cyhvbGRNYXJrZXJzKSwgcm93ID0+IHtcblx0XHRpZiAoIV8uY29udGFpbnMocm93cywgcm93KSkge1xuXHRcdFx0ZGVzdHJveU1hcmtlckF0Um93KHJvdyk7XG5cdFx0fVxuXHR9KTtcbn07XG5cbmNvbnN0IHNhdmVNYXJrZXIgPSAobWFya2VyLCByb3cpID0+IHtcblx0Y29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG5cdGlmICghbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSkge1xuXHRcdG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF0gPSB7fTtcblx0fVxuXG5cdG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF1bcm93XSA9IG1hcmtlcjtcbn07XG5cbmNvbnN0IGdldE1hcmtlckF0Um93ID0gcm93ID0+IHtcblx0Y29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG5cdGlmICghbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSkge1xuXHRcdHJldHVybiBudWxsO1xuXHR9XG5cblx0cmV0dXJuIG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF1bcm93XTtcbn07XG5cbmNvbnN0IHVwZGF0ZVN0YXR1c2JhciA9ICgpID0+IHtcblx0Y29uc3Qgc3RhdHVzQmFyID0gYXRvbS52aWV3cy5nZXRWaWV3KGF0b20ud29ya3NwYWNlKS5xdWVyeVNlbGVjdG9yKCcuc3RhdHVzLWJhcicpO1xuXHRpZiAoIXN0YXR1c0Jhcikge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGlmICghanNIaW50U3RhdHVzQmFyLnBhcmVudE5vZGUpIHtcblx0XHRzdGF0dXNCYXIuYWRkTGVmdFRpbGUoe2l0ZW06IGpzSGludFN0YXR1c0Jhcn0pO1xuXHR9XG5cblx0Y29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXHRpZiAoIWVkaXRvciB8fCAhZXJyb3JzQnlFZGl0b3JJZFtlZGl0b3IuaWRdKSB7XG5cdFx0dXBkYXRlU3RhdHVzVGV4dCgpO1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGNvbnN0IGxpbmUgPSBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKS5yb3cgKyAxO1xuXHRsZXQgZXJyb3IgPSBlcnJvcnNCeUVkaXRvcklkW2VkaXRvci5pZF1bbGluZV0gfHwgXy5maXJzdChfLmNvbXBhY3QoZXJyb3JzQnlFZGl0b3JJZFtlZGl0b3IuaWRdKSk7XG5cdGVycm9yID0gZXJyb3JbMF07XG5cblx0dXBkYXRlU3RhdHVzVGV4dChlcnJvci5saW5lLCBlcnJvci5jaGFyYWN0ZXIsIGVycm9yLnJlYXNvbik7XG59O1xuXG5jb25zdCBnZXRSZWFzb25zRm9yRXJyb3IgPSBlcnJvciA9PiB7XG5cdHJldHVybiBfLm1hcChlcnJvciwgZWwgPT4gYCR7ZWwuY2hhcmFjdGVyfTogJHtlbC5yZWFzb259YCk7XG59O1xuXG5cbmNvbnN0IGFkZFJlYXNvbnMgPSAobWFya2VyLCBlcnJvcikgPT4ge1xuXHRjb25zdCByb3cgPSBnZXRSb3dGb3JFcnJvcihlcnJvcik7XG5cdGNvbnN0IGVkaXRvckVsZW1lbnQgPSBhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpKTtcblx0Y29uc3QgcmVhc29ucyA9IGA8ZGl2IGNsYXNzPVwianNoaW50LWVycm9yc1wiPiR7Z2V0UmVhc29uc0ZvckVycm9yKGVycm9yKS5qb2luKCc8YnI+Jyl9PC9kaXY+YDtcblxuXHRjb25zdCB0YXJnZXQgPSBlZGl0b3JFbGVtZW50LnNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvckFsbCgnLmpzaGludC1saW5lLW51bWJlci5saW5lLW51bWJlci0nICsgcm93KTtcblx0Y29uc3QgdG9vbHRpcCA9IGF0b20udG9vbHRpcHMuYWRkKHRhcmdldCwge1xuXHRcdHRpdGxlOiByZWFzb25zLFxuXHRcdHBsYWNlbWVudDogJ2JvdHRvbScsXG5cdFx0ZGVsYXk6IHtzaG93OiAyMDB9XG5cdH0pO1xuXHRzdWJzY3JpcHRpb25Ub29sdGlwcy5hZGQodG9vbHRpcCk7XG59O1xuXG5jb25zdCBkaXNwbGF5RXJyb3IgPSBlcnJvciA9PiB7XG5cdGNvbnN0IHJvdyA9IGdldFJvd0ZvckVycm9yKGVycm9yKTtcblxuXHRpZiAoZ2V0TWFya2VyQXRSb3cocm93KSkge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblx0Y29uc3QgbWFya2VyID0gZWRpdG9yLm1hcmtCdWZmZXJSYW5nZShbW3JvdywgMF0sIFtyb3csIDFdXSk7XG5cdGVkaXRvci5kZWNvcmF0ZU1hcmtlcihtYXJrZXIsIHt0eXBlOiAnbGluZScsIGNsYXNzOiAnanNoaW50LWxpbmUnfSk7XG5cdGVkaXRvci5kZWNvcmF0ZU1hcmtlcihtYXJrZXIsIHt0eXBlOiAnbGluZS1udW1iZXInLCBjbGFzczogJ2pzaGludC1saW5lLW51bWJlcid9KTtcblx0c2F2ZU1hcmtlcihtYXJrZXIsIHJvdyk7XG5cdGFkZFJlYXNvbnMobWFya2VyLCBlcnJvcik7XG59O1xuXG5jb25zdCBkaXNwbGF5RXJyb3JzID0gKCkgPT4ge1xuXHRjb25zdCBlcnJvcnMgPSBfLmNvbXBhY3QoZ2V0RXJyb3JzRm9yRWRpdG9yKCkpO1xuXHRjbGVhck9sZE1hcmtlcnMoZXJyb3JzKTtcblx0dXBkYXRlU3RhdHVzYmFyKCk7XG5cdF8uZWFjaChlcnJvcnMsIGRpc3BsYXlFcnJvcik7XG59O1xuXG5jb25zdCByZW1vdmVNYXJrZXJzRm9yRWRpdG9ySWQgPSBpZCA9PiB7XG5cdGlmIChtYXJrZXJzQnlFZGl0b3JJZFtpZF0pIHtcblx0XHRkZWxldGUgbWFya2Vyc0J5RWRpdG9ySWRbaWRdO1xuXHR9XG59O1xuXG5jb25zdCByZW1vdmVFcnJvcnNGb3JFZGl0b3JJZCA9IGlkID0+IHtcblx0aWYgKGVycm9yc0J5RWRpdG9ySWRbaWRdKSB7XG5cdFx0ZGVsZXRlIGVycm9yc0J5RWRpdG9ySWRbaWRdO1xuXHR9XG59O1xuXG5jb25zdCBsaW50ID0gKCkgPT4ge1xuXHRjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG5cblx0aWYgKCFlZGl0b3IpIHtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRpZiAoU1VQUE9SVEVEX0dSQU1NQVJTLmluZGV4T2YoZWRpdG9yLmdldEdyYW1tYXIoKS5zY29wZU5hbWUpID09PSAtMSkge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGNvbnN0IGZpbGUgPSBlZGl0b3IuZ2V0VVJJKCk7XG5cblx0Ly8gSGFjayB0byBtYWtlIEpTSGludCBsb29rIGZvciAuanNoaW50aWdub3JlIGluIHRoZSBjb3JyZWN0IGRpclxuXHQvLyBCZWNhdXNlIEpTSGludCBkb2Vzbid0IHVzZSBpdHMgYGN3ZGAgb3B0aW9uXG5cdHByb2Nlc3MuY2hkaXIocGF0aC5kaXJuYW1lKGZpbGUpKTtcblxuXHQvLyBSZW1vdmUgZXJyb3JzIGFuZCBkb24ndCBsaW50IGlmIGZpbGUgaXMgaWdub3JlZCBpbiAuanNoaW50aWdub3JlXG5cdGlmIChmaWxlICYmIGNsaSgpLmdhdGhlcih7YXJnczogW2ZpbGVdfSkubGVuZ3RoID09PSAwKSB7XG5cdFx0cmVtb3ZlRXJyb3JzRm9yRWRpdG9ySWQoZWRpdG9yLmlkKTtcblx0XHRkaXNwbGF5RXJyb3JzKCk7XG5cdFx0cmVtb3ZlTWFya2Vyc0ZvckVkaXRvcklkKGVkaXRvci5pZCk7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0Y29uc3QgY29uZmlnID0gZmlsZSA/IGxvYWRDb25maWcoKShmaWxlKSA6IHt9O1xuXG5cdGNvbnN0IGxpbnRlciA9IChhdG9tLmNvbmZpZy5nZXQoJ2pzaGludC5zdXBwb3J0TGludGluZ0pzeCcpIHx8IGF0b20uY29uZmlnLmdldCgnanNoaW50LnRyYW5zZm9ybUpzeCcpKSA/IGpzeGhpbnQoKS5KU1hISU5UIDoganNoaW50KCkuSlNISU5UO1xuXG5cdGNvbnN0IG9yaWdDb2RlID0gZWRpdG9yLmdldFRleHQoKTtcblx0Y29uc3QgZ3JhbW1hclNjb3BlID0gZWRpdG9yLmdldEdyYW1tYXIoKS5zY29wZU5hbWU7XG5cdGNvbnN0IGlzSnN4ID0gZ3JhbW1hclNjb3BlID09PSAnc291cmNlLmpzeCcgfHwgZ3JhbW1hclNjb3BlID09PSAnc291cmNlLmpzLmpzeCc7XG5cdGNvbnN0IGNvZGUgPSBpc0pzeCA/IHJlYWN0RG9tUHJhZ21hKG9yaWdDb2RlKSA6IG9yaWdDb2RlO1xuXHRjb25zdCBwcmFnbWFXYXNBZGRlZCA9IGNvZGUgIT09IG9yaWdDb2RlO1xuXG5cdHRyeSB7XG5cdFx0bGludGVyKGNvZGUsIGNvbmZpZywgY29uZmlnLmdsb2JhbHMpO1xuXHR9IGNhdGNoIChlcnIpIHt9XG5cblx0cmVtb3ZlRXJyb3JzRm9yRWRpdG9ySWQoZWRpdG9yLmlkKTtcblxuXHQvLyB3b3JrYXJvdW5kIHRoZSBlcnJvcnMgYXJyYXkgc29tZXRpbWVzIGNvbnRhaW5pbmcgYG51bGxgXG5cdGNvbnN0IGVycm9ycyA9IF8uY29tcGFjdChsaW50ZXIuZXJyb3JzKTtcblxuXHRpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcblx0XHQvLyBhZ2dyZWdhdGUgc2FtZS1saW5lIGVycm9yc1xuXHRcdGNvbnN0IHJldCA9IFtdO1xuXHRcdF8uZWFjaChlcnJvcnMsIGVsID0+IHtcblx0XHRcdGlmIChwcmFnbWFXYXNBZGRlZCkge1xuXHRcdFx0XHRlbC5saW5lLS07XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGwgPSBlbC5saW5lO1xuXG5cdFx0XHRpZiAoQXJyYXkuaXNBcnJheShyZXRbbF0pKSB7XG5cdFx0XHRcdHJldFtsXS5wdXNoKGVsKTtcblxuXHRcdFx0XHRyZXRbbF0gPSBfLnNvcnRCeShyZXRbbF0sIGVsID0+IGVsLmNoYXJhY3Rlcik7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRyZXRbbF0gPSBbZWxdO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0ZXJyb3JzQnlFZGl0b3JJZFtlZGl0b3IuaWRdID0gcmV0O1xuXHR9XG5cblx0ZGlzcGxheUVycm9ycygpO1xufTtcblxubGV0IGRlYm91bmNlZExpbnQgPSBudWxsO1xubGV0IGRlYm91bmNlZERpc3BsYXlFcnJvcnMgPSBudWxsO1xubGV0IGRlYm91bmNlZFVwZGF0ZVN0YXR1c2JhciA9IG51bGw7XG5cbmNvbnN0IHJlZ2lzdGVyRXZlbnRzID0gKCkgPT4ge1xuXHRsaW50KCk7XG5cdGNvbnN0IHdvcmtzcGFjZUVsZW1lbnQgPSBhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpO1xuXG5cdGRlYm91bmNlZExpbnQgPSBkZWJvdW5jZWRMaW50IHx8IF8uZGVib3VuY2UobGludCwgNTApO1xuXHRkZWJvdW5jZWREaXNwbGF5RXJyb3JzID0gZGVib3VuY2VkRGlzcGxheUVycm9ycyB8fCBfLmRlYm91bmNlKGRpc3BsYXlFcnJvcnMsIDIwMCk7XG5cdGRlYm91bmNlZFVwZGF0ZVN0YXR1c2JhciA9IGRlYm91bmNlZFVwZGF0ZVN0YXR1c2JhciB8fCBfLmRlYm91bmNlKHVwZGF0ZVN0YXR1c2JhciwgMTAwKTtcblxuXHRhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoZWRpdG9yID0+IHtcblx0XHRjb25zdCBidWZmZXIgPSBlZGl0b3IuZ2V0QnVmZmVyKCk7XG5cblx0XHRlZGl0b3IuZW1pdHRlci5vZmYoJ3Njcm9sbC10b3AtY2hhbmdlZCcsIGRlYm91bmNlZERpc3BsYXlFcnJvcnMpO1xuXHRcdGVkaXRvci5lbWl0dGVyLm9mZignZGlkLWNoYW5nZS1jdXJzb3ItcG9zaXRpb24nLCBkZWJvdW5jZWRVcGRhdGVTdGF0dXNiYXIpO1xuXHRcdGJ1ZmZlci5lbWl0dGVyLm9mZignZGlkLXNhdmUgZGlkLWNoYW5nZS1tb2RpZmllZCcsIGRlYm91bmNlZExpbnQpO1xuXG5cdFx0aWYgKCFhdG9tLmNvbmZpZy5nZXQoJ2pzaGludC52YWxpZGF0ZU9ubHlPblNhdmUnKSkge1xuXHRcdFx0YnVmZmVyLm9uRGlkQ2hhbmdlTW9kaWZpZWQoZGVib3VuY2VkTGludCk7XG5cdFx0fVxuXG5cdFx0YnVmZmVyLm9uRGlkU2F2ZShkZWJvdW5jZWRMaW50KTtcblxuXHRcdGVkaXRvci5vbkRpZENoYW5nZVNjcm9sbFRvcChkZWJvdW5jZWREaXNwbGF5RXJyb3JzKTtcblx0XHRlZGl0b3Iub25EaWRDaGFuZ2VDdXJzb3JQb3NpdGlvbihkZWJvdW5jZWRVcGRhdGVTdGF0dXNiYXIpO1xuXHR9KTtcblxuXHR3b3Jrc3BhY2VFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2VkaXRvcjp3aWxsLWJlLXJlbW92ZWQnLCAoZSwgZWRpdG9yVmlldykgPT4ge1xuXHRcdGlmIChlZGl0b3JWaWV3ICYmIGVkaXRvclZpZXcuZWRpdG9yKSB7XG5cdFx0XHRyZW1vdmVFcnJvcnNGb3JFZGl0b3JJZChlZGl0b3JWaWV3LmVkaXRvci5pZCk7XG5cdFx0XHRyZW1vdmVNYXJrZXJzRm9yRWRpdG9ySWQoZWRpdG9yVmlldy5lZGl0b3IuaWQpO1xuXHRcdH1cblx0fSk7XG59O1xuXG5leHBvcnQgY29uc3QgY29uZmlnID0gcGx1Z2luLmNvbmZpZyA9IHtcblx0dmFsaWRhdGVPbmx5T25TYXZlOiB7XG5cdFx0dHlwZTogJ2Jvb2xlYW4nLFxuXHRcdGRlZmF1bHQ6IGZhbHNlXG5cdH0sXG5cdHN1cHBvcnRMaW50aW5nSnN4OiB7XG5cdFx0dHlwZTogJ2Jvb2xlYW4nLFxuXHRcdGRlZmF1bHQ6IGZhbHNlLFxuXHRcdHRpdGxlOiAnU3VwcG9ydCBMaW50aW5nIEpTWCdcblx0fVxufTtcblxuZXhwb3J0IGNvbnN0IGFjdGl2YXRlID0gcGx1Z2luLmFjdGl2YXRlID0gKCkgPT4ge1xuXHRfID0gbG9kYXNoKCk7XG5cdHJlZ2lzdGVyRXZlbnRzKCk7XG5cdGF0b20uY29uZmlnLm9ic2VydmUoJ2pzaGludC52YWxpZGF0ZU9ubHlPblNhdmUnLCByZWdpc3RlckV2ZW50cyk7XG5cdGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsICdqc2hpbnQ6bGludCcsIGxpbnQpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgcGx1Z2luO1xuIl19