/* globals atom */
'use strict';
var CompositeDisposable = require('atom').CompositeDisposable;
var emissary = require('emissary');
var lazyReq = require('lazy-req')(require);
var lodash = lazyReq('lodash');
var jshint = lazyReq('jshint');
var jsxhint = lazyReq('jshint-jsx');
var path = require('path');
var cli = lazyReq('jshint/src/cli');
var reactDomPragma = require('react-dom-pragma');
var loadConfig = lazyReq('./load-config');
var plugin = module.exports;
var _;
var markersByEditorId = {};
var errorsByEditorId = {};
var subscriptionTooltips = new CompositeDisposable();

emissary.Subscriber.extend(plugin);

var SUPPORTED_GRAMMARS = ['source.js', 'source.jsx', 'source.js.jsx'];

var jsHintStatusBar = document.createElement('span');
jsHintStatusBar.setAttribute('id', 'jshint-statusbar');
jsHintStatusBar.classList.add('inline-block');

function updateStatusText(line, character, reason) {
	jsHintStatusBar.textContent = line && character && reason ? 'JSHint ' + line + ':' + character + ' ' + reason : '';
}

function getMarkersForEditor() {
	var editor = atom.workspace.getActiveTextEditor();

	if (editor && markersByEditorId[editor.id]) {
		return markersByEditorId[editor.id];
	}

	return {};
}

function getErrorsForEditor() {
	var editor = atom.workspace.getActiveTextEditor();

	if (editor && errorsByEditorId[editor.id]) {
		return errorsByEditorId[editor.id];
	}

	return [];
}

function clearOldMarkers(errors) {
	subscriptionTooltips.dispose();

	var rows = _.map(errors, function (error) {
		return getRowForError(error);
	});

	var oldMarkers = getMarkersForEditor();
	_.each(_.keys(oldMarkers), function (row) {
		if (!_.contains(rows, row)) {
			destroyMarkerAtRow(row);
		}
	});
}

function destroyMarkerAtRow(row) {
	var editor = atom.workspace.getActiveTextEditor();
	if (markersByEditorId[editor.id] && markersByEditorId[editor.id][row]) {
		markersByEditorId[editor.id][row].destroy();
		delete markersByEditorId[editor.id][row];
	}
}

function saveMarker(marker, row) {
	var editor = atom.workspace.getActiveTextEditor();

	if (!markersByEditorId[editor.id]) {
		markersByEditorId[editor.id] = {};
	}

	markersByEditorId[editor.id][row] = marker;
}

function getMarkerAtRow(row) {
	var editor = atom.workspace.getActiveTextEditor();

	if (!markersByEditorId[editor.id]) {
		return null;
	}

	return markersByEditorId[editor.id][row];
}

function updateStatusbar() {
	var statusBar = atom.views.getView(atom.workspace).querySelector('.status-bar');
	if (!statusBar) {
		return;
	}

	if (!jsHintStatusBar.parentNode) {
		statusBar.addLeftTile({ item: jsHintStatusBar });
	}

	var editor = atom.workspace.getActiveTextEditor();
	if (!editor || !errorsByEditorId[editor.id]) {
		updateStatusText();
		return;
	}

	var line = editor.getCursorBufferPosition().row + 1;
	var error = errorsByEditorId[editor.id][line] || _.first(_.compact(errorsByEditorId[editor.id]));
	error = error[0];

	updateStatusText(error.line, error.character, error.reason);
}

function getRowForError(error) {
	var line = error[0].line || 1; // JSHint reports `line: 0` when config error
	var row = line - 1;
	return row;
}

function displayError(error) {
	var row = getRowForError(error);

	if (getMarkerAtRow(row)) {
		return;
	}

	var editor = atom.workspace.getActiveTextEditor();
	var marker = editor.markBufferRange([[row, 0], [row, 1]]);
	editor.decorateMarker(marker, { type: 'line', 'class': 'jshint-line' });
	editor.decorateMarker(marker, { type: 'line-number', 'class': 'jshint-line-number' });
	saveMarker(marker, row);
	addReasons(marker, error);
}

function getReasonsForError(error) {
	return _.map(error, function (el) {
		return el.character + ': ' + el.reason;
	});
}

function addReasons(marker, error) {
	var row = getRowForError(error);
	var editorElement = atom.views.getView(atom.workspace.getActiveTextEditor());
	var reasons = '<div class="jshint-errors">' + getReasonsForError(error).join('<br>') + '</div>';

	var target = editorElement.shadowRoot.querySelectorAll('.jshint-line-number.line-number-' + row);
	var tooltip = atom.tooltips.add(target, {
		title: reasons,
		placement: 'bottom',
		delay: { show: 200 }
	});
	subscriptionTooltips.add(tooltip);
}

function lint() {
	var editor = atom.workspace.getActiveTextEditor();

	if (!editor) {
		return;
	}

	if (SUPPORTED_GRAMMARS.indexOf(editor.getGrammar().scopeName) === -1) {
		return;
	}

	var file = editor.getURI();

	// Hack to make JSHint look for .jshintignore in the correct dir
	// Because JSHint doesn't use its `cwd` option
	process.chdir(path.dirname(file));

	// Remove errors and don't lint if file is ignored in .jshintignore
	if (file && cli().gather({ args: [file] }).length === 0) {
		removeErrorsForEditorId(editor.id);
		displayErrors();
		removeMarkersForEditorId(editor.id);
		return;
	}

	var config = file ? loadConfig()(file) : {};

	var linter = atom.config.get('jshint.supportLintingJsx') || atom.config.get('jshint.transformJsx') ? jsxhint().JSXHINT : jshint().JSHINT;

	var origCode = editor.getText();
	var code = editor.getGrammar().scopeName === 'source.jsx' ? reactDomPragma(origCode) : origCode;
	var pragmaWasAdded = code !== origCode;

	try {
		linter(code, config, config.globals);
	} catch (err) {}

	removeErrorsForEditorId(editor.id);

	// workaround the errors array sometimes containing `null`
	var errors = _.compact(linter.errors);

	if (errors.length > 0) {
		// aggregate same-line errors
		var ret = [];
		_.each(errors, function (el) {
			if (pragmaWasAdded) {
				el.line--;
			}

			var l = el.line;

			if (Array.isArray(ret[l])) {
				ret[l].push(el);

				ret[l] = _.sortBy(ret[l], function (el) {
					return el.character;
				});
			} else {
				ret[l] = [el];
			}
		});

		errorsByEditorId[editor.id] = ret;
	}

	displayErrors();
}

var debouncedLint = null;

function displayErrors() {
	var errors = _.compact(getErrorsForEditor());
	clearOldMarkers(errors);
	updateStatusbar();
	_.each(errors, displayError);
}

var debouncedDisplayErrors = null;

function removeMarkersForEditorId(id) {
	if (markersByEditorId[id]) {
		delete markersByEditorId[id];
	}
}

function removeErrorsForEditorId(id) {
	if (errorsByEditorId[id]) {
		delete errorsByEditorId[id];
	}
}

function registerEvents() {
	lint();
	var workspaceElement = atom.views.getView(atom.workspace);

	atom.workspace.observeTextEditors(function (editor) {
		var buffer = editor.getBuffer();
		debouncedLint = debouncedLint || _.debounce(lint, 50);
		debouncedDisplayErrors = debouncedDisplayErrors || _.debounce(displayErrors, 200);

		editor.emitter.off('scroll-top-changed', debouncedDisplayErrors);
		buffer.emitter.off('did-save did-change-modified', debouncedLint);

		if (!atom.config.get('jshint.validateOnlyOnSave')) {
			buffer.onDidChangeModified(debouncedLint);
		}

		buffer.onDidSave(debouncedLint);

		editor.onDidChangeScrollTop(debouncedDisplayErrors);
	});

	workspaceElement.addEventListener('editor:will-be-removed', function (e, editorView) {
		if (editorView && editorView.editor) {
			removeErrorsForEditorId(editorView.editor.id);
			removeMarkersForEditorId(editorView.editor.id);
		}
	});

	workspaceElement.addEventListener('cursor:moved', updateStatusbar);
}

plugin.config = {
	validateOnlyOnSave: {
		type: 'boolean',
		'default': false
	},
	supportLintingJsx: {
		type: 'boolean',
		'default': false,
		title: 'Support Linting JSX'
	}
};

plugin.activate = function () {
	_ = lodash();
	registerEvents();
	plugin.subscribe(atom.config.observe('jshint.validateOnlyOnSave', registerEvents));
	atom.commands.add('atom-workspace', 'jshint:lint', lint);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zYXJhaC8uYXRvbS9wYWNrYWdlcy9qc2hpbnQvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLFlBQVksQ0FBQztBQUNiLElBQUksbUJBQW1CLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLG1CQUFtQixDQUFDO0FBQzlELElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNuQyxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDM0MsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDcEMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQ3BDLElBQUksY0FBYyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ2pELElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUMxQyxJQUFJLE1BQU0sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO0FBQzVCLElBQUksQ0FBQyxDQUFDO0FBQ04sSUFBSSxpQkFBaUIsR0FBRyxFQUFFLENBQUM7QUFDM0IsSUFBSSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUFDMUIsSUFBSSxvQkFBb0IsR0FBRyxJQUFJLG1CQUFtQixFQUFFLENBQUM7O0FBRXJELFFBQVEsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDOztBQUVuQyxJQUFJLGtCQUFrQixHQUFHLENBQ3hCLFdBQVcsRUFDWCxZQUFZLEVBQ1osZUFBZSxDQUNmLENBQUM7O0FBRUYsSUFB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QztDQUN6RCxDQUFDIiwiZmlsZSI6Ii9Vc2Vycy9zYXJhaC8uYXRvbS9wYWNrYWdlcy9qc2hpbnQvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBnbG9iYWxzIGF0b20gKi9cbid1c2Ugc3RyaWN0JztcbnZhciBDb21wb3NpdGVEaXNwb3NhYmxlID0gcmVxdWlyZSgnYXRvbScpLkNvbXBvc2l0ZURpc3Bvc2FibGU7XG52YXIgZW1pc3NhcnkgPSByZXF1aXJlKCdlbWlzc2FyeScpO1xudmFyIGxhenlSZXEgPSByZXF1aXJlKCdsYXp5LXJlcScpKHJlcXVpcmUpO1xudmFyIGxvZGFzaCA9IGxhenlSZXEoJ2xvZGFzaCcpO1xudmFyIGpzaGludCA9IGxhenlSZXEoJ2pzaGludCcpO1xudmFyIGpzeGhpbnQgPSBsYXp5UmVxKCdqc2hpbnQtanN4Jyk7XG52YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbnZhciBjbGkgPSBsYXp5UmVxKCdqc2hpbnQvc3JjL2NsaScpO1xudmFyIHJlYWN0RG9tUHJhZ21hID0gcmVxdWlyZSgncmVhY3QtZG9tLXByYWdtYScpO1xudmFyIGxvYWRDb25maWcgPSBsYXp5UmVxKCcuL2xvYWQtY29uZmlnJyk7XG52YXIgcGx1Z2luID0gbW9kdWxlLmV4cG9ydHM7XG52YXIgXztcbnZhciBtYXJrZXJzQnlFZGl0b3JJZCA9IHt9O1xudmFyIGVycm9yc0J5RWRpdG9ySWQgPSB7fTtcbnZhciBzdWJzY3JpcHRpb25Ub29sdGlwcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG5cbmVtaXNzYXJ5LlN1YnNjcmliZXIuZXh0ZW5kKHBsdWdpbik7XG5cbnZhciBTVVBQT1JURURfR1JBTU1BUlMgPSBbXG5cdCdzb3VyY2UuanMnLFxuXHQnc291cmNlLmpzeCcsXG5cdCdzb3VyY2UuanMuanN4J1xuXTtcblxudmFyIGpzSGludFN0YXR1c0JhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcbmpzSGludFN0YXR1c0Jhci5zZXRBdHRyaWJ1dGUoJ2lkJywgJ2pzaGludC1zdGF0dXNiYXInKTtcbmpzSGludFN0YXR1c0Jhci5jbGFzc0xpc3QuYWRkKCdpbmxpbmUtYmxvY2snKTtcblxuZnVuY3Rpb24gdXBkYXRlU3RhdHVzVGV4dChsaW5lLCBjaGFyYWN0ZXIsIHJlYXNvbikge1xuXHRqc0hpbnRTdGF0dXNCYXIudGV4dENvbnRlbnQgPSBsaW5lICYmIGNoYXJhY3RlciAmJiByZWFzb24gPyAnSlNIaW50ICcgKyBsaW5lICsgJzonICsgY2hhcmFjdGVyICsgJyAnICsgcmVhc29uIDogJyc7XG59XG5cbmZ1bmN0aW9uIGdldE1hcmtlcnNGb3JFZGl0b3IoKSB7XG5cdHZhciBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG5cblx0aWYgKGVkaXRvciAmJiBtYXJrZXJzQnlFZGl0b3JJZFtlZGl0b3IuaWRdKSB7XG5cdFx0cmV0dXJuIG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF07XG5cdH1cblxuXHRyZXR1cm4ge307XG59XG5cbmZ1bmN0aW9uIGdldEVycm9yc0ZvckVkaXRvcigpIHtcblx0dmFyIGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblxuXHRpZiAoZWRpdG9yICYmIGVycm9yc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSkge1xuXHRcdHJldHVybiBlcnJvcnNCeUVkaXRvcklkW2VkaXRvci5pZF07XG5cdH1cblxuXHRyZXR1cm4gW107XG59XG5cbmZ1bmN0aW9uIGNsZWFyT2xkTWFya2VycyhlcnJvcnMpIHtcblx0c3Vic2NyaXB0aW9uVG9vbHRpcHMuZGlzcG9zZSgpO1xuXG5cdHZhciByb3dzID0gXy5tYXAoZXJyb3JzLCBmdW5jdGlvbiAoZXJyb3IpIHtcblx0XHRyZXR1cm4gZ2V0Um93Rm9yRXJyb3IoZXJyb3IpO1xuXHR9KTtcblxuXHR2YXIgb2xkTWFya2VycyA9IGdldE1hcmtlcnNGb3JFZGl0b3IoKTtcblx0Xy5lYWNoKF8ua2V5cyhvbGRNYXJrZXJzKSwgZnVuY3Rpb24gKHJvdykge1xuXHRcdGlmICghXy5jb250YWlucyhyb3dzLCByb3cpKSB7XG5cdFx0XHRkZXN0cm95TWFya2VyQXRSb3cocm93KTtcblx0XHR9XG5cdH0pO1xufVxuXG5mdW5jdGlvbiBkZXN0cm95TWFya2VyQXRSb3cocm93KSB7XG5cdHZhciBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG5cdGlmIChtYXJrZXJzQnlFZGl0b3JJZFtlZGl0b3IuaWRdICYmIG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF1bcm93XSkge1xuXHRcdG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF1bcm93XS5kZXN0cm95KCk7XG5cdFx0ZGVsZXRlIG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF1bcm93XTtcblx0fVxufVxuXG5mdW5jdGlvbiBzYXZlTWFya2VyKG1hcmtlciwgcm93KSB7XG5cdHZhciBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG5cblx0aWYgKCFtYXJrZXJzQnlFZGl0b3JJZFtlZGl0b3IuaWRdKSB7XG5cdFx0bWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSA9IHt9O1xuXHR9XG5cblx0bWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXVtyb3ddID0gbWFya2VyO1xufVxuXG5mdW5jdGlvbiBnZXRNYXJrZXJBdFJvdyhyb3cpIHtcblx0dmFyIGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblxuXHRpZiAoIW1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF0pIHtcblx0XHRyZXR1cm4gbnVsbDtcblx0fVxuXG5cdHJldHVybiBtYXJrZXJzQnlFZGl0b3JJZFtlZGl0b3IuaWRdW3Jvd107XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVN0YXR1c2JhcigpIHtcblx0dmFyIHN0YXR1c0JhciA9IGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSkucXVlcnlTZWxlY3RvcignLnN0YXR1cy1iYXInKTtcblx0aWYgKCFzdGF0dXNCYXIpIHtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRpZiAoIWpzSGludFN0YXR1c0Jhci5wYXJlbnROb2RlKSB7XG5cdFx0c3RhdHVzQmFyLmFkZExlZnRUaWxlKHtpdGVtOiBqc0hpbnRTdGF0dXNCYXJ9KTtcblx0fVxuXG5cdHZhciBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG5cdGlmICghZWRpdG9yIHx8ICFlcnJvcnNCeUVkaXRvcklkW2VkaXRvci5pZF0pIHtcblx0XHR1cGRhdGVTdGF0dXNUZXh0KCk7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0dmFyIGxpbmUgPSBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKS5yb3cgKyAxO1xuXHR2YXIgZXJyb3IgPSBlcnJvcnNCeUVkaXRvcklkW2VkaXRvci5pZF1bbGluZV0gfHwgXy5maXJzdChfLmNvbXBhY3QoZXJyb3JzQnlFZGl0b3JJZFtlZGl0b3IuaWRdKSk7XG5cdGVycm9yID0gZXJyb3JbMF07XG5cblx0dXBkYXRlU3RhdHVzVGV4dChlcnJvci5saW5lLCBlcnJvci5jaGFyYWN0ZXIsIGVycm9yLnJlYXNvbik7XG59XG5cbmZ1bmN0aW9uIGdldFJvd0ZvckVycm9yKGVycm9yKSB7XG5cdHZhciBsaW5lID0gZXJyb3JbMF0ubGluZSB8fCAxOyAvLyBKU0hpbnQgcmVwb3J0cyBgbGluZTogMGAgd2hlbiBjb25maWcgZXJyb3Jcblx0dmFyIHJvdyA9IGxpbmUgLSAxO1xuXHRyZXR1cm4gcm93O1xufVxuXG5mdW5jdGlvbiBkaXNwbGF5RXJyb3IoZXJyb3IpIHtcblx0dmFyIHJvdyA9IGdldFJvd0ZvckVycm9yKGVycm9yKTtcblxuXHRpZiAoZ2V0TWFya2VyQXRSb3cocm93KSkge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdHZhciBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG5cdHZhciBtYXJrZXIgPSBlZGl0b3IubWFya0J1ZmZlclJhbmdlKFtbcm93LCAwXSwgW3JvdywgMV1dKTtcblx0ZWRpdG9yLmRlY29yYXRlTWFya2VyKG1hcmtlciwge3R5cGU6ICdsaW5lJywgY2xhc3M6ICdqc2hpbnQtbGluZSd9KTtcblx0ZWRpdG9yLmRlY29yYXRlTWFya2VyKG1hcmtlciwge3R5cGU6ICdsaW5lLW51bWJlcicsIGNsYXNzOiAnanNoaW50LWxpbmUtbnVtYmVyJ30pO1xuXHRzYXZlTWFya2VyKG1hcmtlciwgcm93KTtcblx0YWRkUmVhc29ucyhtYXJrZXIsIGVycm9yKTtcbn1cblxuZnVuY3Rpb24gZ2V0UmVhc29uc0ZvckVycm9yKGVycm9yKSB7XG5cdHJldHVybiBfLm1hcChlcnJvciwgZnVuY3Rpb24gKGVsKSB7XG5cdFx0cmV0dXJuIGVsLmNoYXJhY3RlciArICc6ICcgKyBlbC5yZWFzb247XG5cdH0pO1xufVxuXG5mdW5jdGlvbiBhZGRSZWFzb25zKG1hcmtlciwgZXJyb3IpIHtcblx0dmFyIHJvdyA9IGdldFJvd0ZvckVycm9yKGVycm9yKTtcblx0dmFyIGVkaXRvckVsZW1lbnQgPSBhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpKTtcblx0dmFyIHJlYXNvbnMgPSAnPGRpdiBjbGFzcz1cImpzaGludC1lcnJvcnNcIj4nICsgZ2V0UmVhc29uc0ZvckVycm9yKGVycm9yKS5qb2luKCc8YnI+JykgKyAnPC9kaXY+JztcblxuXHR2YXIgdGFyZ2V0ID0gZWRpdG9yRWxlbWVudC5zaGFkb3dSb290LnF1ZXJ5U2VsZWN0b3JBbGwoJy5qc2hpbnQtbGluZS1udW1iZXIubGluZS1udW1iZXItJyArIHJvdyk7XG5cdHZhciB0b29sdGlwID0gYXRvbS50b29sdGlwcy5hZGQodGFyZ2V0LCB7XG5cdFx0dGl0bGU6IHJlYXNvbnMsXG5cdFx0cGxhY2VtZW50OiAnYm90dG9tJyxcblx0XHRkZWxheTogeyBzaG93OiAyMDAgfVxuXHR9KTtcblx0c3Vic2NyaXB0aW9uVG9vbHRpcHMuYWRkKHRvb2x0aXApO1xufVxuXG5mdW5jdGlvbiBsaW50KCkge1xuXHR2YXIgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG5cdGlmICghZWRpdG9yKSB7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0aWYgKFNVUFBPUlRFRF9HUkFNTUFSUy5pbmRleE9mKGVkaXRvci5nZXRHcmFtbWFyKCkuc2NvcGVOYW1lKSA9PT0gLTEpIHtcblx0XHRyZXR1cm47XG5cdH1cblxuXHR2YXIgZmlsZSA9IGVkaXRvci5nZXRVUkkoKTtcblxuXHQvLyBIYWNrIHRvIG1ha2UgSlNIaW50IGxvb2sgZm9yIC5qc2hpbnRpZ25vcmUgaW4gdGhlIGNvcnJlY3QgZGlyXG5cdC8vIEJlY2F1c2UgSlNIaW50IGRvZXNuJ3QgdXNlIGl0cyBgY3dkYCBvcHRpb25cblx0cHJvY2Vzcy5jaGRpcihwYXRoLmRpcm5hbWUoZmlsZSkpO1xuXG5cdC8vIFJlbW92ZSBlcnJvcnMgYW5kIGRvbid0IGxpbnQgaWYgZmlsZSBpcyBpZ25vcmVkIGluIC5qc2hpbnRpZ25vcmVcblx0aWYgKGZpbGUgJiYgY2xpKCkuZ2F0aGVyKHthcmdzOiBbZmlsZV19KS5sZW5ndGggPT09IDApIHtcblx0XHRyZW1vdmVFcnJvcnNGb3JFZGl0b3JJZChlZGl0b3IuaWQpO1xuXHRcdGRpc3BsYXlFcnJvcnMoKTtcblx0XHRyZW1vdmVNYXJrZXJzRm9yRWRpdG9ySWQoZWRpdG9yLmlkKTtcblx0XHRyZXR1cm47XG5cdH1cblxuXHR2YXIgY29uZmlnID0gZmlsZSA/IGxvYWRDb25maWcoKShmaWxlKSA6IHt9O1xuXG5cdHZhciBsaW50ZXIgPSAoYXRvbS5jb25maWcuZ2V0KCdqc2hpbnQuc3VwcG9ydExpbnRpbmdKc3gnKSB8fCBhdG9tLmNvbmZpZy5nZXQoJ2pzaGludC50cmFuc2Zvcm1Kc3gnKSkgPyBqc3hoaW50KCkuSlNYSElOVCA6IGpzaGludCgpLkpTSElOVDtcblxuXHR2YXIgb3JpZ0NvZGUgPSBlZGl0b3IuZ2V0VGV4dCgpO1xuXHR2YXIgY29kZSA9IGVkaXRvci5nZXRHcmFtbWFyKCkuc2NvcGVOYW1lID09PSAnc291cmNlLmpzeCcgPyByZWFjdERvbVByYWdtYShvcmlnQ29kZSkgOiBvcmlnQ29kZTtcblx0dmFyIHByYWdtYVdhc0FkZGVkID0gY29kZSAhPT0gb3JpZ0NvZGU7XG5cblx0dHJ5IHtcblx0XHRsaW50ZXIoY29kZSwgY29uZmlnLCBjb25maWcuZ2xvYmFscyk7XG5cdH0gY2F0Y2ggKGVycikge31cblxuXHRyZW1vdmVFcnJvcnNGb3JFZGl0b3JJZChlZGl0b3IuaWQpO1xuXG5cdC8vIHdvcmthcm91bmQgdGhlIGVycm9ycyBhcnJheSBzb21ldGltZXMgY29udGFpbmluZyBgbnVsbGBcblx0dmFyIGVycm9ycyA9IF8uY29tcGFjdChsaW50ZXIuZXJyb3JzKTtcblxuXHRpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcblx0XHQvLyBhZ2dyZWdhdGUgc2FtZS1saW5lIGVycm9yc1xuXHRcdHZhciByZXQgPSBbXTtcblx0XHRfLmVhY2goZXJyb3JzLCBmdW5jdGlvbiAoZWwpIHtcblx0XHRcdGlmIChwcmFnbWFXYXNBZGRlZCkge1xuXHRcdFx0XHRlbC5saW5lLS07XG5cdFx0XHR9XG5cblx0XHRcdHZhciBsID0gZWwubGluZTtcblxuXHRcdFx0aWYgKEFycmF5LmlzQXJyYXkocmV0W2xdKSkge1xuXHRcdFx0XHRyZXRbbF0ucHVzaChlbCk7XG5cblx0XHRcdFx0cmV0W2xdID0gXy5zb3J0QnkocmV0W2xdLCBmdW5jdGlvbiAoZWwpIHtcblx0XHRcdFx0XHRyZXR1cm4gZWwuY2hhcmFjdGVyO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHJldFtsXSA9IFtlbF07XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRlcnJvcnNCeUVkaXRvcklkW2VkaXRvci5pZF0gPSByZXQ7XG5cdH1cblxuXHRkaXNwbGF5RXJyb3JzKCk7XG59XG5cbnZhciBkZWJvdW5jZWRMaW50ID0gbnVsbDtcblxuZnVuY3Rpb24gZGlzcGxheUVycm9ycygpIHtcblx0dmFyIGVycm9ycyA9IF8uY29tcGFjdChnZXRFcnJvcnNGb3JFZGl0b3IoKSk7XG5cdGNsZWFyT2xkTWFya2VycyhlcnJvcnMpO1xuXHR1cGRhdGVTdGF0dXNiYXIoKTtcblx0Xy5lYWNoKGVycm9ycywgZGlzcGxheUVycm9yKTtcbn1cblxudmFyIGRlYm91bmNlZERpc3BsYXlFcnJvcnMgPSBudWxsO1xuXG5mdW5jdGlvbiByZW1vdmVNYXJrZXJzRm9yRWRpdG9ySWQoaWQpIHtcblx0aWYgKG1hcmtlcnNCeUVkaXRvcklkW2lkXSkge1xuXHRcdGRlbGV0ZSBtYXJrZXJzQnlFZGl0b3JJZFtpZF07XG5cdH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlRXJyb3JzRm9yRWRpdG9ySWQoaWQpIHtcblx0aWYgKGVycm9yc0J5RWRpdG9ySWRbaWRdKSB7XG5cdFx0ZGVsZXRlIGVycm9yc0J5RWRpdG9ySWRbaWRdO1xuXHR9XG59XG5cbmZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzKCkge1xuXHRsaW50KCk7XG5cdHZhciB3b3Jrc3BhY2VFbGVtZW50ID0gYXRvbS52aWV3cy5nZXRWaWV3KGF0b20ud29ya3NwYWNlKTtcblxuXHRhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoZnVuY3Rpb24gKGVkaXRvcikge1xuXHRcdHZhciBidWZmZXIgPSBlZGl0b3IuZ2V0QnVmZmVyKCk7XG5cdFx0ZGVib3VuY2VkTGludCA9IGRlYm91bmNlZExpbnQgfHwgXy5kZWJvdW5jZShsaW50LCA1MCk7XG5cdFx0ZGVib3VuY2VkRGlzcGxheUVycm9ycyA9IGRlYm91bmNlZERpc3BsYXlFcnJvcnMgfHwgXy5kZWJvdW5jZShkaXNwbGF5RXJyb3JzLCAyMDApO1xuXG5cdFx0ZWRpdG9yLmVtaXR0ZXIub2ZmKCdzY3JvbGwtdG9wLWNoYW5nZWQnLCBkZWJvdW5jZWREaXNwbGF5RXJyb3JzKTtcblx0XHRidWZmZXIuZW1pdHRlci5vZmYoJ2RpZC1zYXZlIGRpZC1jaGFuZ2UtbW9kaWZpZWQnLCBkZWJvdW5jZWRMaW50KTtcblxuXHRcdGlmICghYXRvbS5jb25maWcuZ2V0KCdqc2hpbnQudmFsaWRhdGVPbmx5T25TYXZlJykpIHtcblx0XHRcdGJ1ZmZlci5vbkRpZENoYW5nZU1vZGlmaWVkKGRlYm91bmNlZExpbnQpO1xuXHRcdH1cblxuXHRcdGJ1ZmZlci5vbkRpZFNhdmUoZGVib3VuY2VkTGludCk7XG5cblx0XHRlZGl0b3Iub25EaWRDaGFuZ2VTY3JvbGxUb3AoZGVib3VuY2VkRGlzcGxheUVycm9ycyk7XG5cdH0pO1xuXG5cdHdvcmtzcGFjZUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZWRpdG9yOndpbGwtYmUtcmVtb3ZlZCcsIGZ1bmN0aW9uIChlLCBlZGl0b3JWaWV3KSB7XG5cdFx0aWYgKGVkaXRvclZpZXcgJiYgZWRpdG9yVmlldy5lZGl0b3IpIHtcblx0XHRcdHJlbW92ZUVycm9yc0ZvckVkaXRvcklkKGVkaXRvclZpZXcuZWRpdG9yLmlkKTtcblx0XHRcdHJlbW92ZU1hcmtlcnNGb3JFZGl0b3JJZChlZGl0b3JWaWV3LmVkaXRvci5pZCk7XG5cdFx0fVxuXHR9KTtcblxuXHR3b3Jrc3BhY2VFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2N1cnNvcjptb3ZlZCcsIHVwZGF0ZVN0YXR1c2Jhcik7XG59XG5cbnBsdWdpbi5jb25maWcgPSB7XG5cdHZhbGlkYXRlT25seU9uU2F2ZToge1xuXHRcdHR5cGU6ICdib29sZWFuJyxcblx0XHRkZWZhdWx0OiBmYWxzZVxuXHR9LFxuXHRzdXBwb3J0TGludGluZ0pzeDoge1xuXHRcdHR5cGU6ICdib29sZWFuJyxcblx0XHRkZWZhdWx0OiBmYWxzZSxcblx0XHR0aXRsZTogJ1N1cHBvcnQgTGludGluZyBKU1gnXG5cdH1cbn07XG5cbnBsdWdpbi5hY3RpdmF0ZSA9IGZ1bmN0aW9uICgpIHtcblx0XyA9IGxvZGFzaCgpO1xuXHRyZWdpc3RlckV2ZW50cygpO1xuXHRwbHVnaW4uc3Vic2NyaWJlKGF0b20uY29uZmlnLm9ic2VydmUoJ2pzaGludC52YWxpZGF0ZU9ubHlPblNhdmUnLCByZWdpc3RlckV2ZW50cykpO1xuXHRhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS13b3Jrc3BhY2UnLCAnanNoaW50OmxpbnQnLCBsaW50KTtcbn07XG4iXX0=